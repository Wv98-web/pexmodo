{%- liquid
	layout none
	assign collection = collections[settings.search_prs_suggest]
	assign limit = 5
	assign search_pr_type = search.terms
	assign check = true
	assign show_search_suggest = settings.show_search_suggest
	assign on_sale_txt = 'products.product.on_sale' | t
	assign save_js = 'products.product.save_js' | t: saved_amount:'saved_amount' -%}

<div class="nt_mini_cart flex column h__100">
	<div class="mini_cart_header flex fl_between al_center"><h3 class="widget-title tu fs__16 mg__0">{{ 'general.search.title' | t }}</h3><i class="close_pp pegk pe-7s-close ts__03 cd"></i></div>
	<div class="mini_cart_wrap">
		<form action="{{ routes.search_url }}" method="get" class="search_header mini_search_frm pr js_frm_search" role="search">
			<input type="hidden" name="type" value="product">
			<input type="hidden" name="options[unavailable_products]" value="{{settings.unavailable_prs}}">
			<input type="hidden" name="options[prefix]" value="last">
			{%- if shop.types[0] == blank and shop.types.size == 1 %}{% assign check = false %}{% endif -%}
			{%- if settings.filter_type_search and shop.types.size > 0 and check -%}
			<div class="frm_search_cat mb__20">
				<select name="product_type">
				<option value="*">{{ 'general.search.all_cat' | t }}</option>
				{%- for product_type in shop.types -%}{%- if product_type == blank %}{% continue-%}{% endif -%}<option value="{{product_type}}"{% if search_pr_type == product_type %} selected="selected"{% endif %}>{{product_type}}</option>{%- endfor -%}
				</select>
			</div>
			{%- endif -%}
			<div class="frm_search_input pr oh">
				<input class="search_header__input js_iput_search" autocomplete="off" type="text" name="q" placeholder="{{ 'general.search.placeholder' | t }}">
				<button class="search_header__submit js_btn_search{% if settings.ajax_search %} pe_none{% endif %}" type="submit"><i class="iccl iccl-search"></i></button>
			</div>
			{%- assign list_hotkey = settings.list_hotkey -%}
			{%- if settings.show_search_hotkey and list_hotkey != blank -%}
				{%- capture link_suggest -%}
				{{ routes.search_url }}?type=product&options%5Bunavailable_products%5D={{settings.unavailable_prs}}&options%5Bprefix%5D=last&q=
				{%- endcapture -%}
				{%- assign arr_keys = list_hotkey  | replace: ' ,', ',' | replace: ', ', ',' | split:',' -%}
				{%- assign arr_keys2 = arr_keys | join:',|nt'  | split:'|nt' -%}
				<div class="search_header_keys mt__10 ml__20 fs__12 flex wrap">
					<p class="search_header_keys__label cd mr__5 mg__0">{{'general.quick_search' | t}}</p>
					<ul class="ul_none dib">
						{%- for key in arr_keys %}{% assign key_strip = key | strip -%}
						<li class="dib"><a data-key='{{key_strip | escape }}' class="cg fwb4" href="{{link_suggest}}{{key | strip | url_encode }}">{{arr_keys2[forloop.index0]}} </a></li>
					{% endfor -%}
					</ul>
				</div>
			{%- endif -%}
			<div class="ld_bar_search"></div>
		</form>
		<div class="search_header__prs fwsb cd{% if collection == blank or show_search_suggest == false %} dn{% endif %}">
			{%- if collection != blank and show_search_suggest %}<span class="h_suggest">{{ 'general.search.suggest' | t }}</span>{% endif %}<span class="h_result dn">{{ 'general.search.result' | t }}</span><span class="h_results dn">{{ 'general.search.results' | t }}</span>
		</div>
		{% comment %} 之前的标签 {% endcomment %}
		{% comment %} <div class="search_header__content mini_cart_content fixcl-scroll widget{% if collection == blank or show_search_suggest == false %} dn{% endif %}">
         <div class="fixcl-scroll-content product_list_widget"> {% endcomment %}
		<div class="search_header__content mini_cart_content widget{% if collection == blank or show_search_suggest == false %} dn{% endif %}">
			<div class="product_list_widget">
				<div class="skeleton_wrap skeleton_js dn">
					{%- for i in (1..4) -%}
					<div class="row mb__10 pb__10">
						<div class="col-auto widget_img_pr"><div class="skeleton_img"></div></div>
						<div class="col widget_if_pr"><div class="skeleton_txt1"></div><div class="skeleton_txt2"></div></div>
					</div>
					{%- endfor -%}
				</div>
				<div class="js_prs_search">
				{%- if collection != blank and show_search_suggest -%}
					{%- for product in collection.products limit:limit -%}{%- render 'pr_group_loop',product:product,on_sale_txt:on_sale_txt,save_js:save_js -%}{%- endfor -%}
					{%- if collection.all_products_count > limit -%}<a href="{{collection.url}}" class="btn db fwsb detail_link">{{ 'general.search.view_all' | t }} <i class="las la-arrow-right fs__18"></i></a>{%- endif -%}
				{%- endif -%}
				</div>
			</div>
		</div>
		{% comment %} 新加的搜索推荐模块开始 {% endcomment %}
		<div class="search_recommend mb__20">
			{%- if linklists[settings.recommend_menu].links.size > 0 -%}
			<div class="search_header_hh fwsb cd">Search Discovery</div>
			<ul class="search_tags">
				{%- for link in linklists[settings.recommend_menu].links -%}
				{%- assign arrlt = link.title | split: '[' -%}
				{%- assign collection = link.object -%}
				<li>
					<a href="{{link.url}}">
						<i class="las la-fire-alt"></i>{{ link.title }}
					</a>
				</li>
				{%- endfor -%}
			</ul>
			{%- endif -%}

			{%- if settings.recommend_collection.products_count > 0 -%}
				<div class="search_header_hh fwsb cd">Hot Sale</div>
				<ul class="search_products">
					{%- for product in settings.recommend_collection.products -%}
					{%- liquid
						assign rtl = settings.use_rtl
						assign default = product.has_only_default_variant
						assign no_sold_out = product.available
						if no_sold_out
							assign remove_soldout = settings.remove_sold_out
						else
							assign remove_soldout = false
						endif
						assign pr_variants = product.variants
						assign variants_size = pr_variants.size 
						assign selected_variant = product.selected_variant
						assign pr_curent = settings.pr_curent
						if pr_curent == '2'
							assign current_variant = selected_variant |default: pr_variants.first
							if remove_soldout and current_variant.available == false and no_sold_out 
							assign current_variant = product.first_available_variant 
							endif
						else 
							assign current_variant = product.selected_or_first_available_variant 
						endif
							assign default = product.has_only_default_variant
							assign on_sale = false 
							if current_variant.compare_at_price > current_variant.price 
							assign on_sale = true  
							endif 
						assign call_cl = '_qs'
						assign values = product.options_with_values | map: 'values' | join: ',' | downcase
						assign pr_images = product.media | where: "media_type", "image"
						assign pr_incoming_mess = settings.pr_incoming_mess
						assign price_varies = product.price_varies | default:product.compare_at_price_varies
						if price_varies
						assign cl_price_varies = 'price_varies'
						endif
						assign PR_no_pick = false
						if pr_curent == '1' and variants_size > 1 and selected_variant == blank
							assign PR_no_pick = true
						endif
						assign PR_buy_qs = false
						if no_sold_out and settings.use_buy_qs
							assign PR_buy_qs = true
						endif
						assign locale_url = product.url | split:'/products/' | first
						assign image_0 = settings.placeholder_img -%}
					<li>
						<div class="qs_imgs_i row al_center mb__10">
							{%- if pr_images.size > 0 -%}
							<div class="col-auto cl_pr_img">
								<div class="pr oh qs_imgs_wrap">
									<div class="row equal_nt qs_imgs{% if pr_images.size > 1 %} nt_slider nt_carousel_qs p-thumb_qs{% endif %}" data-flickityt4s-js='{"fade":false,"cellSelector": ".qs_img_i","cellAlign": "center","wrapAround": true,"autoPlay": false,"prevNextButtons":false,"adaptiveHeight": true,"imagesLoaded": false, "lazyload": 0,"dragThreshold" : 0,"pageDots": false,"rightToLeft": {{rtl}} }'>
										{%- for image in pr_images -%}{%- assign alt = image.alt -%}{%- assign ratio = image.aspect_ratio -%}{%- if image.alt contains 't4_360' -%}{%- break -%}{%- endif -%}{%- assign img_alt = alt | split:'|' | first | strip | downcase -%}
										<div data-mdid="{{image.id}}" data-mdtype="image" class="col-12 js-sl-item qs_img_i nt_img_ratio lazyloadt4s nt_bg_lz{% if values contains img_alt %} bc_{{img_alt | handleize }}{% endif %}" data-vid="{{image.variants.first.id}}" id="imgqs_{{image.id}}" data-bgset="{{ image | img_url: '1x1' }}" data-ratio="{{ratio}}" data-sizes="auto" style="padding-top:{{ 1 | divided_by: ratio | times: 100}}%;"></div>
										{%- endfor -%}
									</div>
								</div>
							</div>
							{%- elsif image_0 != blank -%}{%- assign ratio = image_0.aspect_ratio -%}
							<div class="col-auto cl_pr_img">
								<div class="pr oh qs_imgs_wrap">
									<div class="row equal_nt qs_imgs">
										<div data-mdid="{{image_0.id}}" data-mdtype="image" class="col-12 js-sl-item qs_img_i nt_img_ratio lazyloadt4s nt_bg_lz" id="imgqs_{{image_0.id}}" data-bgset="{{ image_0 | img_url: '1x1' }}" data-ratio="{{ratio}}" data-sizes="auto" style="padding-top:{{ 1 | divided_by: ratio | times: 100}}%;"></div>
									</div>
								</div>
							</div>
							{%- endif -%}

							<div class="col cl_pr_title tc">
								<h3 class="product-title pr fs__16 mg__0 fwm"><a class="cd chp" href="{{product.url |within:collection}}">{{product.title}}</a></h3>
							{%- unless product.tags contains 't4_hide_price' -%}
								<div id="price_qs">
							{%- if current_variant.unit_price_measurement -%}
								<span class="price_varies">{%- if on_sale -%}<del>{{ current_variant.compare_at_price  | money }}</del><ins>{{ current_variant.price | money }}</ins>{%- else -%}{{ current_variant.price | money }}{%- endif -%}</span>
								{%- capture unit_price_base_unit -%}
									<span class="unit_base">
									{%- if current_variant.unit_price_measurement -%}
										{%- if current_variant.unit_price_measurement.reference_value != 1 -%}
										{{- current_variant.unit_price_measurement.reference_value -}}
										{%- endif -%}
										{{ current_variant.unit_price_measurement.reference_unit }}
									{%- endif -%}
									</span>
								{%- endcapture -%}
								<span class="price__unit db"><span class="unit_price">{{ current_variant.unit_price | money }}</span><span>/</span>{{- unit_price_base_unit -}}</span>
							{%- elsif on_sale -%}<span class="price {{cl_price_varies}}"><del>{{ current_variant.compare_at_price | money }}</del> <ins>{{ current_variant.price | money }}</ins></span>
								{%- if on_sale and settings.use_sale_label -%}{%- if settings.label_sale_style == '1' -%}<span class="qs_label onsale cw"><span>{{ 'products.product.on_sale' | t }}</span></span>{%- else-%}{%- assign save = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: product.compare_at_price | round -%}<span class="qs_label onsale cw{% if save >= 50 %} per_50{% endif %}"><span>{{ 'products.product.save_js' | t: saved_amount:save }}</span></span>{%- endif -%}{%- endif -%}
							{%- else -%}<span class="price {{cl_price_varies}}">{{ current_variant.price | money }}</span>
								{%- if on_sale and settings.use_sale_label -%}{%- if settings.label_sale_style == '1' -%}<span class="qs_label onsale cw dn"><span>{{ 'products.product.on_sale' | t }}</span></span>{%- else-%}<span class="qs_label onsale cw"><span></span></span>{%- endif -%}{%- endif -%}
							{%- endif -%}
								</div>
							{%- endunless -%}
							</div>
						</div>
					</li>
					{%- endfor -%}
				</ul>
			{%- endif -%}
		</div>
		{% comment %} 搜索推荐模块结束 {% endcomment %}
	</div>
</div>
